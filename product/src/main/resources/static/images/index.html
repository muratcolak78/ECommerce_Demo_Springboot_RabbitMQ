<!doctype html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Product Catalog</title>
    <style>
        :root{
          --bg:#0b1020;
          --card:#0f1733;
          --muted:#9aa7c7;
          --text:#e8eeff;
          --accent:#7aa2ff;
          --border:rgba(255,255,255,.08);
          --shadow: 0 18px 60px rgba(0,0,0,.35);
          --radius:18px;
        }
        *{box-sizing:border-box}
        body{
          margin:0;
          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
          background: radial-gradient(1200px 700px at 20% -10%, rgba(122,162,255,.35), transparent 60%),
                      radial-gradient(900px 600px at 110% 10%, rgba(160,122,255,.25), transparent 60%),
                      radial-gradient(900px 600px at 50% 120%, rgba(60,220,180,.18), transparent 60%),
                      var(--bg);
          color:var(--text);
          min-height:100vh;
        }

        header{
          position:sticky; top:0;
          backdrop-filter: blur(12px);
          background: linear-gradient(to bottom, rgba(11,16,32,.85), rgba(11,16,32,.55));
          border-bottom:1px solid var(--border);
          z-index:10;
        }
        .wrap{max-width:1100px; margin:0 auto; padding:18px 16px;}
        .topbar{
          display:flex; gap:14px; align-items:center; justify-content:space-between;
          flex-wrap:wrap;
        }
        .brand{
          display:flex; align-items:center; gap:10px;
          font-weight:700; letter-spacing:.2px;
        }
        .logo{
          width:38px; height:38px; border-radius:12px;
          background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(60,220,180,.9));
          box-shadow: 0 10px 35px rgba(122,162,255,.25);
        }
        .subtitle{font-size:12px; color:var(--muted); font-weight:500; margin-top:2px}

        .controls{
          display:flex; gap:10px; align-items:center; flex-wrap:wrap;
        }
        .input, .select, .btn{
          border:1px solid var(--border);
          background: rgba(255,255,255,.04);
          color:var(--text);
          border-radius: 14px;
          padding:10px 12px;
          outline:none;
        }
        .input{min-width:260px}
        .select{min-width:170px}
        .btn{
          cursor:pointer;
          font-weight:600;
          transition: transform .06s ease, background .15s ease;
        }
        .btn:hover{background: rgba(255,255,255,.07)}
        .btn:active{transform: translateY(1px)}
        .pill{
          font-size:12px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid var(--border);
          color:var(--muted);
          background: rgba(255,255,255,.03);
        }

        main{padding:18px 0 48px}
        .grid{
          display:grid;
          grid-template-columns: repeat(12, 1fr);
          gap:14px;
        }
        .card{
          grid-column: span 3;
          background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
          border:1px solid var(--border);
          border-radius: var(--radius);
          overflow:hidden;
          box-shadow: var(--shadow);
          cursor:pointer;
          transition: transform .12s ease, border-color .12s ease;
          position:relative;
        }
        .card:hover{transform: translateY(-2px); border-color: rgba(122,162,255,.35)}
        @media (max-width: 1000px){ .card{grid-column: span 4;} }
        @media (max-width: 720px){ .card{grid-column: span 6;} .input{min-width: 200px;} }
        @media (max-width: 480px){ .card{grid-column: span 12;} }

        .imgwrap{
          aspect-ratio: 4/3;
          background: rgba(255,255,255,.03);
          display:flex; align-items:center; justify-content:center;
          overflow:hidden;
        }
        .imgwrap img{
          width:100%; height:100%;
          object-fit: cover;
          display:block;
          transform: scale(1.02);
        }
        .body{
          padding:12px 12px 14px;
          display:flex; flex-direction:column; gap:8px;
        }
        .name{
          font-weight:700;
          line-height:1.2;
          display:-webkit-box;
          -webkit-line-clamp:2;
          -webkit-box-orient: vertical;
          overflow:hidden;
          min-height: 38px;
        }
        .row{
          display:flex; align-items:center; justify-content:space-between; gap:10px;
          color:var(--muted);
          font-size:13px;
        }
        .price{
          font-size:15px;
          font-weight:800;
          color: var(--text);
        }
        .tag{
          font-size:12px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid rgba(122,162,255,.22);
          color: rgba(196,214,255,.95);
          background: rgba(122,162,255,.12);
          white-space:nowrap;
        }

        .state{
          border:1px dashed var(--border);
          border-radius: var(--radius);
          padding:16px;
          color:var(--muted);
          grid-column: 1 / -1;
          background: rgba(255,255,255,.02);
        }
        .error{border-color: rgba(255,120,120,.35); color: rgba(255,200,200,.92)}

        /* Modal */
        dialog{
          width:min(880px, 92vw);
          border:none;
          border-radius: 22px;
          padding:0;
          background: rgba(15,23,51,.92);
          color: var(--text);
          box-shadow: 0 30px 120px rgba(0,0,0,.55);
        }
        dialog::backdrop{
          background: rgba(0,0,0,.55);
          backdrop-filter: blur(8px);
        }
        .modal{
          display:grid;
          grid-template-columns: 1.2fr 1fr;
          gap:0;
          overflow:hidden;
        }
        @media (max-width: 780px){ .modal{grid-template-columns: 1fr;} }
        .modal-img{
          background: rgba(255,255,255,.03);
          min-height: 320px;
        }
        .modal-img img{width:100%; height:100%; object-fit: cover; display:block}
        .modal-body{
          padding:18px 18px 16px;
          display:flex; flex-direction:column; gap:10px;
        }
        .modal-title{font-size:20px; font-weight:800; margin:0}
        .muted{color:var(--muted)}
        .kv{display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; font-size:14px}
        .kv div{padding:6px 0; border-bottom: 1px solid rgba(255,255,255,.06)}
        .kv div:nth-last-child(-n+2){border-bottom:none}
        .modal-actions{
          display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px
        }
        .close{
          background: rgba(255,255,255,.06);
          border:1px solid var(--border);
          color:var(--text);
          border-radius: 14px;
          padding:10px 12px;
          cursor:pointer;
          font-weight:700;
        }
        .accent{
          border-color: rgba(122,162,255,.35);
          background: rgba(122,162,255,.14);
        }
    </style>
</head>

<body>
<header>
    <div class="wrap">
        <div class="topbar">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <div>Product Catalog</div>
                    <div class="subtitle">Spring Boot + SQLite · Static images from <code>/images</code></div>
                </div>
            </div>

            <div class="controls">
                <input id="search" class="input" placeholder="Search products (name / brand / category)..." />
                <select id="category" class="select">
                    <option value="">All categories</option>
                </select>
                <button id="reload" class="btn">Reload</button>
                <span id="count" class="pill">0 items</span>
            </div>
        </div>
    </div>
</header>

<main>
    <div class="wrap">
        <div id="grid" class="grid"></div>
    </div>
</main>

<dialog id="detailDialog">
    <div class="modal">
        <div class="modal-img"><img id="dImg" alt=""></div>
        <div class="modal-body">
            <p class="modal-title" id="dTitle"></p>
            <div class="row">
                <span class="tag" id="dCat"></span>
                <span class="price" id="dPrice"></span>
            </div>
            <p class="muted" id="dDesc" style="margin:0"></p>

            <div class="kv">
                <div class="muted">Brand</div><div id="dBrand"></div>
                <div class="muted">Stock</div><div id="dStock"></div>
                <div class="muted">Created</div><div id="dCreated"></div>
                <div class="muted">ID</div><div id="dId"></div>
            </div>

            <div class="modal-actions">
                <button class="close" id="closeBtn">Close</button>
                <a class="close accent" id="openImg" target="_blank" rel="noreferrer">Open image</a>
            </div>
        </div>
    </div>
</dialog>

<script>

    const API_BASE = "http://localhost:8081";
    const LIST_ENDPOINT = `${API_BASE}/api/product`;
    const DETAIL_ENDPOINT = (id) => `${API_BASE}/api/products/${id}`;

    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("search");
    const categorySelect = document.getElementById("category");
    const countPill = document.getElementById("count");
    const reloadBtn = document.getElementById("reload");

    const dlg = document.getElementById("detailDialog");
    const closeBtn = document.getElementById("closeBtn");

    const dImg = document.getElementById("dImg");
    const dTitle = document.getElementById("dTitle");
    const dCat = document.getElementById("dCat");
    const dPrice = document.getElementById("dPrice");
    const dDesc = document.getElementById("dDesc");
    const dBrand = document.getElementById("dBrand");
    const dStock = document.getElementById("dStock");
    const dCreated = document.getElementById("dCreated");
    const dId = document.getElementById("dId");
    const openImg = document.getElementById("openImg");

    let allProducts = [];
    let categories = [];

    const fmtPrice = (value) => {
      try {
        return new Intl.NumberFormat("de-DE", { style:"currency", currency:"EUR" }).format(Number(value));
      } catch {
        return `${value} €`;
      }
    };

    const safeText = (v, fallback="") => (v === null || v === undefined || v === "") ? fallback : String(v);

    function buildImageUrl(imageUrl) {
      // DB: "/images/xxx.jpg" → API_BASE + imageUrl
      if (!imageUrl) return "";
      if (imageUrl.startsWith("http://") || imageUrl.startsWith("https://")) return imageUrl;
      return `${API_BASE}${imageUrl}`;
    }

    function setState(message, isError=false) {
      grid.innerHTML = `
        <div class="state ${isError ? "error":""}">
          ${message}
        </div>
      `;
    }

    function renderCategories() {
      categorySelect.innerHTML = `<option value="">All categories</option>`;
      categories.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        categorySelect.appendChild(opt);
      });
    }

    function matches(p, q, cat) {
      const hay = `${safeText(p.name)} ${safeText(p.brand)} ${safeText(p.category)}`.toLowerCase();
      const okQ = !q || hay.includes(q.toLowerCase());
      const okC = !cat || safeText(p.category) === cat;
      return okQ && okC;
    }

    function renderGrid() {
      const q = searchInput.value.trim();
      const cat = categorySelect.value;

      const filtered = allProducts.filter(p => matches(p, q, cat));
      countPill.textContent = `${filtered.length} items`;

      if (filtered.length === 0) {
        setState("No products found. Try a different search or category.");
        return;
      }

      grid.innerHTML = "";
      filtered.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        const imgSrc = buildImageUrl(p.imageUrl);

        card.innerHTML = `
          <div class="imgwrap">
            <img src="${imgSrc}" alt="${safeText(p.name, "Product image")}" onerror="this.style.opacity=.2; this.alt='Image not found';" />
          </div>
          <div class="body">
            <div class="name">${safeText(p.name, "Unnamed product")}</div>
            <div class="row">
              <span class="tag">${safeText(p.category, "UNKNOWN")}</span>
              <span class="price">${fmtPrice(p.price)}</span>
            </div>
            <div class="row">
              <span>Stock: <b style="color:var(--text)">${safeText(p.stock, "-")}</b></span>
              <span class="muted">${safeText(p.brand, "")}</span>
            </div>
          </div>
        `;

        card.addEventListener("click", () => openDetails(p));
        grid.appendChild(card);
      });
    }

    async function openDetails(listItem) {
      // Eğer /{id} endpoint'in varsa, oradan detay çekmeye çalışalım.
      // Yoksa list item ile modal açacağız.
      let p = listItem;

      try {
        const res = await fetch(DETAIL_ENDPOINT(listItem.id));
        if (res.ok) {
          p = await res.json();
        }
      } catch {
        // detail endpoint yoksa sessiz geç
      }

      const imgSrc = buildImageUrl(p.imageUrl);

      dImg.src = imgSrc;
      dImg.alt = safeText(p.name, "Product");
      dTitle.textContent = safeText(p.name, "Product");
      dCat.textContent = safeText(p.category, "UNKNOWN");
      dPrice.textContent = fmtPrice(p.price);
      dDesc.textContent = safeText(p.description, "No description available.");

      dBrand.textContent = safeText(p.brand, "-");
      dStock.textContent = safeText(p.stock, "-");
      dCreated.textContent = safeText(p.createdAt, "-");
      dId.textContent = safeText(p.id, "-");

      openImg.href = imgSrc;

      dlg.showModal();
    }

    closeBtn.addEventListener("click", () => dlg.close());
    dlg.addEventListener("click", (e) => {
      // modal dışına tıklayınca kapanma
      const rect = dlg.getBoundingClientRect();
      const inDialog = rect.top <= e.clientY && e.clientY <= rect.bottom && rect.left <= e.clientX && e.clientX <= rect.right;
      if (!inDialog) dlg.close();
    });

    searchInput.addEventListener("input", renderGrid);
    categorySelect.addEventListener("change", renderGrid);
    reloadBtn.addEventListener("click", load);

    async function load() {
      setState("Loading products...");
      try {
        const res = await fetch(LIST_ENDPOINT);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        allProducts = Array.isArray(data) ? data : [];
        categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();
        renderCategories();
        renderGrid();
      } catch (err) {
        setState(
          `Could not load products.<br><br>
           Check that your backend is running and CORS is configured.<br>
           <span class="muted">Endpoint: ${LIST_ENDPOINT}</span><br>
           <span class="muted">Error: ${String(err)}</span>`,
          true
        );
      }
    }

    load();
</script>
</body>
</html>
