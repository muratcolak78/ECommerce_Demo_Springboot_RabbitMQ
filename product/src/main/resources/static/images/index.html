<!doctype html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>E-Commerce Demo</title>
    <style>
        :root{
          --bg:#0b1020;
          --card:#0f1733;
          --muted:#9aa7c7;
          --text:#e8eeff;
          --accent:#7aa2ff;
          --border:rgba(255,255,255,.08);
          --shadow: 0 18px 60px rgba(0,0,0,.35);
          --radius:18px;
        }
        *{box-sizing:border-box}
        body{
          margin:0;
          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
          background: radial-gradient(1200px 700px at 20% -10%, rgba(122,162,255,.35), transparent 60%),
                      radial-gradient(900px 600px at 110% 10%, rgba(160,122,255,.25), transparent 60%),
                      radial-gradient(900px 600px at 50% 120%, rgba(60,220,180,.18), transparent 60%),
                      var(--bg);
          color:var(--text);
          min-height:100vh;
        }

        header{
          position:sticky; top:0;
          backdrop-filter: blur(12px);
          background: linear-gradient(to bottom, rgba(11,16,32,.85), rgba(11,16,32,.55));
          border-bottom:1px solid var(--border);
          z-index:10;
        }
        .wrap{max-width:1100px; margin:0 auto; padding:18px 16px;}
        .topbar{
          display:flex; gap:14px; align-items:center; justify-content:space-between;
          flex-wrap:wrap;
        }
        .brand{
          display:flex; align-items:center; gap:10px;
          font-weight:700; letter-spacing:.2px;
        }
        .logo{
          width:38px; height:38px; border-radius:12px;
          background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(60,220,180,.9));
          box-shadow: 0 10px 35px rgba(122,162,255,.25);
        }
        .subtitle{font-size:12px; color:var(--muted); font-weight:500; margin-top:2px}

        .controls{
          display:flex; gap:10px; align-items:center; flex-wrap:wrap;
        }
        .input, .select, .btn{
          border:1px solid var(--border);
          background: rgba(255,255,255,.04);
          color:var(--text);
          border-radius: 14px;
          padding:10px 12px;
          outline:none;
        }
        .input{min-width:240px}
        .select{min-width:170px}
        .btn{
          cursor:pointer;
          font-weight:600;
          transition: transform .06s ease, background .15s ease;
        }
        .btn:hover{background: rgba(255,255,255,.07)}
        .btn:active{transform: translateY(1px)}
        .pill{
          font-size:12px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid var(--border);
          color:var(--muted);
          background: rgba(255,255,255,.03);
          white-space:nowrap;
        }

        main{padding:18px 0 48px}
        .grid{
          display:grid;
          grid-template-columns: repeat(12, 1fr);
          gap:14px;
        }
        .card{
          grid-column: span 3;
          background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
          border:1px solid var(--border);
          border-radius: var(--radius);
          overflow:hidden;
          box-shadow: var(--shadow);
          cursor:pointer;
          transition: transform .12s ease, border-color .12s ease;
          position:relative;
        }
        .card:hover{transform: translateY(-2px); border-color: rgba(122,162,255,.35)}
        @media (max-width: 1000px){ .card{grid-column: span 4;} }
        @media (max-width: 720px){ .card{grid-column: span 6;} .input{min-width: 200px;} }
        @media (max-width: 480px){ .card{grid-column: span 12;} }

        .imgwrap{
          aspect-ratio: 4/3;
          background: rgba(255,255,255,.03);
          display:flex; align-items:center; justify-content:center;
          overflow:hidden;
        }
        .imgwrap img{
          width:100%; height:100%;
          object-fit: cover;
          display:block;
          transform: scale(1.02);
        }
        .body{
          padding:12px 12px 14px;
          display:flex; flex-direction:column; gap:8px;
        }
        .name{
          font-weight:700;
          line-height:1.2;
          display:-webkit-box;
          -webkit-line-clamp:2;
          -webkit-box-orient: vertical;
          overflow:hidden;
          min-height: 38px;
        }
        .row{
          display:flex; align-items:center; justify-content:space-between; gap:10px;
          color:var(--muted);
          font-size:13px;
        }
        .price{
          font-size:15px;
          font-weight:800;
          color: var(--text);
        }
        .tag{
          font-size:12px;
          padding:6px 10px;
          border-radius:999px;
          border:1px solid rgba(122,162,255,.22);
          color: rgba(196,214,255,.95);
          background: rgba(122,162,255,.12);
          white-space:nowrap;
        }

        .state{
          border:1px dashed var(--border);
          border-radius: var(--radius);
          padding:16px;
          color:var(--muted);
          grid-column: 1 / -1;
          background: rgba(255,255,255,.02);
        }
        .error{border-color: rgba(255,120,120,.35); color: rgba(255,200,200,.92)}

        /* Dialogs */
        dialog{
          width:min(900px, 92vw);
          border:none;
          border-radius: 22px;
          padding:0;
          background: rgba(15,23,51,.92);
          color: var(--text);
          box-shadow: 0 30px 120px rgba(0,0,0,.55);
        }
        dialog::backdrop{
          background: rgba(0,0,0,.55);
          backdrop-filter: blur(8px);
        }
        .modal{
          display:grid;
          grid-template-columns: 1.2fr 1fr;
          gap:0;
          overflow:hidden;
        }
        @media (max-width: 780px){ .modal{grid-template-columns: 1fr;} }
        .modal-img{
          background: rgba(255,255,255,.03);
          min-height: 320px;
        }
        .modal-img img{width:100%; height:100%; object-fit: cover; display:block}
        .modal-body{
          padding:18px 18px 16px;
          display:flex; flex-direction:column; gap:10px;
        }
        .modal-title{font-size:20px; font-weight:800; margin:0}
        .muted{color:var(--muted)}
        .kv{display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; font-size:14px}
        .kv div{padding:6px 0; border-bottom: 1px solid rgba(255,255,255,.06)}
        .kv div:nth-last-child(-n+2){border-bottom:none}
        .modal-actions{
          display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px
        }
        .close{
          background: rgba(255,255,255,.06);
          border:1px solid var(--border);
          color:var(--text);
          border-radius: 14px;
          padding:10px 12px;
          cursor:pointer;
          font-weight:700;
          text-decoration:none;
          display:inline-block;
          text-align:center;
        }
        .accent{
          border-color: rgba(122,162,255,.35);
          background: rgba(122,162,255,.14);
        }

        .two-cols{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap:14px;
          margin-top:14px;
        }
        @media (max-width: 780px){ .two-cols{grid-template-columns:1fr;} }
    </style>
</head>

<body>
<header>
    <div class="wrap">
        <div class="topbar">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>
                    <div>E-Commerce Demo</div>
                    <div class="subtitle">Products + User/Auth (Register/Login) Â· Static images from <code>/images</code></div>
                </div>
            </div>

            <div class="controls">
                <span id="authStatus" class="pill">Not logged in</span>
                <button id="openAuth" class="btn">Register / Login</button>
                <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
                <button id="openCart" class="btn">
                    ðŸ›’ Cart <span id="cartCount" class="pill" style="margin-left:8px;">0</span>
                </button>
                <button id="openOrders" class="btn">
                    ðŸ“¦ Orders <span id="ordersCount" class="pill" style="margin-left:8px;">0</span>
                </button>

                <input id="search" class="input" placeholder="Search products (name / brand / category)..." />
                <select id="category" class="select">
                    <option value="">All categories</option>
                </select>
                <button id="reload" class="btn">Reload</button>
                <span id="count" class="pill">0 items</span>


            </div>
        </div>
    </div>
</header>

<main>
    <div class="wrap">
        <div id="grid" class="grid"></div>
    </div>
</main>

<!-- Product detail dialog -->
<dialog id="detailDialog">
    <div class="modal">
        <div class="modal-img"><img id="dImg" alt=""></div>
        <div class="modal-body">
            <p class="modal-title" id="dTitle"></p>
            <div class="row">
                <span class="tag" id="dCat"></span>
                <span class="price" id="dPrice"></span>
            </div>
            <p class="muted" id="dDesc" style="margin:0"></p>

            <div class="kv">
                <div class="muted">Brand</div><div id="dBrand"></div>
                <div class="muted">Stock</div><div id="dStock"></div>
                <div class="muted">Created</div><div id="dCreated"></div>
                <div class="muted">ID</div><div id="dId"></div>
            </div>

            <div class="modal-actions">
                <button class="close" id="closeBtn">Close</button>
                <a class="close accent" id="openImg" target="_blank" rel="noreferrer">Open image</a>
            </div>
        </div>
    </div>
</dialog>

<!-- Auth dialog -->
<dialog id="authDialog">
    <div style="padding:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:18px;">Account</div>
            <button class="close" id="authClose">Close</button>
        </div>

        <div class="two-cols">
            <!-- Register -->
            <div style="border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px;">
                <div style="font-weight:800; margin-bottom:10px;">Register</div>

                <input id="rEmail" class="input" placeholder="Email" style="width:100%; margin-bottom:8px;" />
                <input id="rPassword" class="input" placeholder="Password" type="password" style="width:100%; margin-bottom:8px;" />
                <input id="rFirst" class="input" placeholder="First name" style="width:100%; margin-bottom:8px;" />
                <input id="rLast" class="input" placeholder="Last name" style="width:100%; margin-bottom:10px;" />

                <button id="registerBtn" class="btn" style="width:100%;">Create account</button>
            </div>

            <!-- Login -->
            <div style="border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px;">
                <div style="font-weight:800; margin-bottom:10px;">Login</div>

                <input id="lEmail" class="input" placeholder="Email" style="width:100%; margin-bottom:8px;" />
                <input id="lPassword" class="input" placeholder="Password" type="password" style="width:100%; margin-bottom:10px;" />

                <button id="loginBtn" class="btn" style="width:100%;">Login</button>
            </div>
        </div>

        <div id="authMsg" class="pill" style="margin-top:12px; display:none;"></div>
    </div>
</dialog>

<dialog id="cartDialog">
    <div style="padding:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:18px;">Your Cart</div>
            <button class="close" id="cartClose">Close</button>
        </div>

        <div id="cartList" style="margin-top:12px;"></div>

        <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px;">

            <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px;">
                <button id="clearCartBtn" class="btn">Clear cart</button>
                <button id="checkoutBtn" class="btn accent">Checkout</button>
                <div id="cartTotal" class="pill">Total: 0 â‚¬</div>
            </div>

        </div>

        <div id="cartMsg" class="pill" style="margin-top:12px; display:none;"></div>
    </div>
</dialog>

<dialog id="ordersDialog">
    <div style="padding:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:18px;">My Orders</div>
            <button class="close" id="ordersClose">Close</button>
        </div>

        <div id="ordersList" style="margin-top:12px;"></div>
        <div id="ordersMsg" class="pill" style="margin-top:12px; display:none;"></div>
    </div>
</dialog>
<dialog id="addressDialog">
    <div style="padding:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:18px;">Delivery Address</div>
            <button class="close" id="addressClose">Close</button>
        </div>

        <div class="two-cols" style="margin-top:12px;">
            <div>
                <input id="aFullName" type="text" class="input" placeholder="Full name" style="width:100%; margin-bottom:8px;" required/>
                <input id="aStreet" type="text" class="input" placeholder="Street" style="width:100%; margin-bottom:8px;" required/>
                <input id="aZip" class="input" placeholder="ZIP" style="width:100%; margin-bottom:8px;" required/>
            </div>
            <div>
                <input id="aCity" type="text" class="input" placeholder="City" style="width:100%; margin-bottom:8px;" required/>
                <input id="aCountry" type="text" class="input" placeholder="Country" style="width:100%; margin-bottom:8px;" required/>
                <input id="aEmail" type="email" class="input" placeholder="Email" style="width:100%; margin-bottom:8px;" required/>
                <input id="aPhone" type="tel" class="input" placeholder="Phone (optional)" style="width:100%; margin-bottom:8px;" />


            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
            <button id="addressContinue" class="btn accent">Continue Checkout</button>
            <span id="addressMsg" class="pill" style="display:none;"></span>
        </div>
    </div>
</dialog>

<dialog id="paymentDialog">
    <div style="padding:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:18px;">Payment</div>
            <button class="close" id="paymentClose">Close</button>
        </div>

        <div class="pill" style="margin-top:10px;">
            Order: <b id="payOrderId">-</b> Â· Total: <b id="payTotal">-</b>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <label class="pill" style="cursor:pointer;">
                <input type="radio" name="payMethod" value="PAYPAL" />
                PayPal
            </label>

            <label class="pill" style="cursor:pointer;">
                <input type="radio" name="payMethod" value="CREDIT_CARD" />
                Credit Card
            </label>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px; align-items:center;">
            <button id="payNowBtn" class="btn accent" disabled>Pay now</button>
            <span id="paySpinner" class="pill" style="display:none;">Processing payment (demo)â€¦</span>
        </div>

        <div id="paymentMsg" class="pill" style="margin-top:12px; display:none;"></div>
    </div>
</dialog>
<dialog id="resultDialog">
    <div style="padding:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:800; font-size:18px;" id="resultTitle">Result</div>
            <button class="close" id="resultClose">Close</button>
        </div>

        <div class="pill" style="margin-top:10px;">
            <span id="resultText">-</span>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px;">
            <button id="resultOk" class="btn accent">OK</button>
        </div>
    </div>
</dialog>


<script>
    // =========================
    // âœ… CONFIG
    // =========================
    const GATEWAY = "http://localhost:8080";

    // User/Auth Service
    const USER_API_BASE = `${GATEWAY}/api/ecommerce/user`;
    const REGISTER_ENDPOINT = `${USER_API_BASE}/register`;
    const LOGIN_ENDPOINT    = `${USER_API_BASE}/login`;
    const USER_KEY = "ecom_user";

    // Cart Service
    const CART_API_BASE = `${GATEWAY}/api/ecommerce/cart`;
    const CART_LIST_ENDPOINT   = `${CART_API_BASE}/items`;
    const CART_ADD_ENDPOINT    = `${CART_API_BASE}/items`;
    const CART_CLEAR_ENDPOINT  = `${CART_API_BASE}/clear`;
    const CART_DELETE_ENDPOINT = (productId) => `${CART_API_BASE}/deleteById/${productId}`;
    const CART_UPDATE_ENDPOINT = (productId) => `${CART_API_BASE}/items/${productId}`;

    // Order Service
    const ORDER_API_BASE = `${GATEWAY}/api/ecommerce/order`;
    const ORDER_CHECKOUT_ENDPOINT = `${ORDER_API_BASE}/checkout`;
    const ORDER_LIST_ENDPOINT = `${ORDER_API_BASE}/orders`;
    const ORDER_DETAIL_ENDPOINT = (orderId) => `${ORDER_API_BASE}/order/${orderId}`;

    // Product Service
    const PRODUCT_API_BASE = `${GATEWAY}`;
    const PRODUCT_LIST_ENDPOINT = `${PRODUCT_API_BASE}/api/product`;

    // Payment Service
    const PAYMENT_API_BASE = `${GATEWAY}/api/ecommerce/payment`;
    const PAYMENT_START_ENDPOINT = `${PAYMENT_API_BASE}/start`;

    // =========================
    // Token storage
    // =========================
    const TOKEN_KEY = "ecom_access_token";
    const getToken  = () => localStorage.getItem(TOKEN_KEY);
    const setToken  = (t) => localStorage.setItem(TOKEN_KEY, t);
    const clearToken = () => localStorage.removeItem(TOKEN_KEY);

    function setUser(user) { localStorage.setItem(USER_KEY, JSON.stringify(user)); }
    function getUser() {
      const u = localStorage.getItem(USER_KEY);
      return u ? JSON.parse(u) : null;
    }
    function clearUser() { localStorage.removeItem(USER_KEY); }

    // =========================
    // Helpers
    // =========================
    let allProducts = [];
    let categories = [];

    const fmtPrice = (value) => {
      try {
        return new Intl.NumberFormat("de-DE", { style:"currency", currency:"EUR" }).format(Number(value));
      } catch {
        return `${value} â‚¬`;
      }
    };

    const safeText = (v, fallback="") => (v === null || v === undefined || v === "") ? fallback : String(v);

    function buildImageUrl(imageUrl) {
      if (!imageUrl) return "";
      if (imageUrl.startsWith("http://") || imageUrl.startsWith("https://")) return imageUrl;
      return `${PRODUCT_API_BASE}${imageUrl}`;
    }

    // =========================
    // UI elements
    // =========================
    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("search");
    const categorySelect = document.getElementById("category");
    const countPill = document.getElementById("count");
    const reloadBtn = document.getElementById("reload");

    const dlg = document.getElementById("detailDialog");
    const closeBtn = document.getElementById("closeBtn");

    const dImg = document.getElementById("dImg");
    const dTitle = document.getElementById("dTitle");
    const dCat = document.getElementById("dCat");
    const dPrice = document.getElementById("dPrice");
    const dDesc = document.getElementById("dDesc");
    const dBrand = document.getElementById("dBrand");
    const dStock = document.getElementById("dStock");
    const dCreated = document.getElementById("dCreated");
    const dId = document.getElementById("dId");
    const openImg = document.getElementById("openImg");

    // Auth UI
    const authStatus = document.getElementById("authStatus");
    const openAuth = document.getElementById("openAuth");
    const logoutBtn = document.getElementById("logoutBtn");

    const authDialog = document.getElementById("authDialog");
    const authClose = document.getElementById("authClose");
    const authMsg = document.getElementById("authMsg");

    const rEmail = document.getElementById("rEmail");
    const rPassword = document.getElementById("rPassword");
    const rFirst = document.getElementById("rFirst");
    const rLast = document.getElementById("rLast");
    const registerBtn = document.getElementById("registerBtn");

    const lEmail = document.getElementById("lEmail");
    const lPassword = document.getElementById("lPassword");
    const loginBtn = document.getElementById("loginBtn");

    // Cart UI
    const openCart = document.getElementById("openCart");
    const cartDialog = document.getElementById("cartDialog");
    const cartClose = document.getElementById("cartClose");
    const cartList = document.getElementById("cartList");
    const cartCount = document.getElementById("cartCount");
    const clearCartBtn = document.getElementById("clearCartBtn");
    const cartTotal = document.getElementById("cartTotal");
    const cartMsg = document.getElementById("cartMsg");
    const checkoutBtn = document.getElementById("checkoutBtn");

    // Orders UI
    const openOrders = document.getElementById("openOrders");
    const ordersDialog = document.getElementById("ordersDialog");
    const ordersClose = document.getElementById("ordersClose");
    const ordersList = document.getElementById("ordersList");
    const ordersMsg = document.getElementById("ordersMsg");
    const ordersCount = document.getElementById("ordersCount");

    // Payment UI (dialog)
    const paymentDialog = document.getElementById("paymentDialog");
    const paymentClose = document.getElementById("paymentClose");
    const payNowBtn = document.getElementById("payNowBtn");
    const payOrderIdEl = document.getElementById("payOrderId");
    const payTotalEl = document.getElementById("payTotal");
    const paymentMsg = document.getElementById("paymentMsg");
    const paySpinner = document.getElementById("paySpinner");

    // Address UI
    const addressDialog = document.getElementById("addressDialog");
    const addressClose = document.getElementById("addressClose");
    const addressContinue = document.getElementById("addressContinue");
    const addressMsg = document.getElementById("addressMsg");

    const aFullName = document.getElementById("aFullName");
    const aStreet = document.getElementById("aStreet");
    const aZip = document.getElementById("aZip");
    const aCity = document.getElementById("aCity");
    const aCountry = document.getElementById("aCountry");
    const aPhone = document.getElementById("aPhone");
    const aEmail = document.getElementById("aEmail");


   // const ADDRESS_KEY = "ecom_delivery_address";

    function addressKey() {
      // token varsa user bazlÄ± key Ã¼ret
      const t = getToken();
      if (!t) return "ecom_delivery_address__guest";
      const payload = parseJwt(t); // sende zaten login sonrasÄ± userId Ã§ektiÄŸin bir ÅŸey var; yoksa aÅŸaÄŸÄ±da vereceÄŸim
      const userId = payload?.userId || payload?.sub || "unknown";
      return `ecom_delivery_address__${userId}`;
    }



    // Result popup
    const resultDialog = document.getElementById("resultDialog");
    const resultClose = document.getElementById("resultClose");
    const resultOk = document.getElementById("resultOk");
    const resultTitle = document.getElementById("resultTitle");
    const resultText = document.getElementById("resultText");


    // =========================
    // State helpers
    // =========================

    function showAddressMsg(text, isError=false){
  addressMsg.style.display = "inline-block";
  addressMsg.textContent = text;
  addressMsg.style.borderColor = isError ? "rgba(255,120,120,.35)" : "rgba(255,255,255,.12)";
  addressMsg.style.color = isError ? "rgba(255,200,200,.92)" : "var(--muted)";
}

function getSavedAddress(){
  const raw = localStorage.getItem(addressKey());
  return raw ? JSON.parse(raw) : null;
}

function setSavedAddress(addr){
  localStorage.setItem(addressKey(), JSON.stringify(addr));
}
function clearSavedAddress(){
  localStorage.removeItem(addressKey());
}

function fillAddressForm(addr){
  if(!addr) return;
  aFullName.value = addr.fullName || "";
  aStreet.value   = addr.street || "";
  aZip.value      = addr.zip || "";
  aCity.value     = addr.city || "";
  aCountry.value  = addr.country || "";
  aPhone.value    = addr.phone || "";
  aEmail.value    = addr.email || "";
}

function readAddressFromForm(){
  return {
    fullName: (aFullName.value || "").trim(),
    street: (aStreet.value || "").trim(),
    zip: (aZip.value || "").trim(),
    city: (aCity.value || "").trim(),
    country: (aCountry.value || "").trim(),
    phone: (aPhone.value || "").trim(),
    email: (aEmail.value || "").trim()
  };
}

function validateAddress(addr){
  if(!addr.fullName) return "Full name is required";
  if(!addr.street) return "Street is required";
  if(!addr.zip) return "ZIP is required";
  if(!addr.city) return "City is required";
  if(!addr.country) return "Country is required";
  if(!addr.email) return "Email is required";

  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(addr.email);
  if(!emailOk) return "Email format is invalid";
  return null;
}

addressClose.addEventListener("click", () => addressDialog.close());
addressDialog.addEventListener("close", () => { addressMsg.style.display = "none"; });

function parseJwt(token) {
  try {
    const base64 = token.split(".")[1].replace(/-/g, "+").replace(/_/g, "/");
    const json = decodeURIComponent(atob(base64).split("").map(c => "%" + c.charCodeAt(0).toString(16).padStart(2,"0")).join(""));
    return JSON.parse(json);
  } catch(e) {
    return null;
  }
}



    function setState(message, isError=false) {
      grid.innerHTML = `<div class="state ${isError ? "error":""}">${message}</div>`;
    }

    function renderCategories() {
      categorySelect.innerHTML = `<option value="">All categories</option>`;
      categories.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        categorySelect.appendChild(opt);
      });
    }

    function matches(p, q, cat) {
      const hay = `${safeText(p.name)} ${safeText(p.brand)} ${safeText(p.category)}`.toLowerCase();
      const okQ = !q || hay.includes(q.toLowerCase());
      const okC = !cat || safeText(p.category) === cat;
      return okQ && okC;
    }

    function renderGrid() {
      const q = searchInput.value.trim();
      const cat = categorySelect.value;

      const filtered = allProducts.filter(p => matches(p, q, cat));
      countPill.textContent = `${filtered.length} items`;

      if (filtered.length === 0) {
        setState("No products found. Try a different search or category.");
        return;
      }

      grid.innerHTML = "";
      filtered.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        const imgSrc = buildImageUrl(p.imageUrl);

        card.innerHTML = `
          <div class="imgwrap">
            <img src="${imgSrc}" alt="${safeText(p.name, "Product image")}"
                 onerror="this.style.opacity=.2; this.alt='Image not found';" />
          </div>
          <div class="body">
            <div class="name">${safeText(p.name, "Unnamed product")}</div>
            <div class="row">
              <span class="tag">${safeText(p.category, "UNKNOWN")}</span>
              <span class="price">${fmtPrice(p.price)}</span>
            </div>
            <div class="row">
              <span>Stock: <b style="color:var(--text)">${safeText(p.stock, "-")}</b></span>
              <span class="muted">${safeText(p.brand, "")}</span>
            </div>
            <button class="btn accent add-cart-btn" data-id="${p.id}">Add to Cart</button>
          </div>
        `;

        card.addEventListener("click", (e) => {
          if (e.target.closest(".add-cart-btn")) return;
          openDetails(p);
        });

        grid.appendChild(card);
      });
    }

    function openDetails(p) {
      const imgSrc = buildImageUrl(p.imageUrl);

      dImg.src = imgSrc;
      dImg.alt = safeText(p.name, "Product");
      dTitle.textContent = safeText(p.name, "Product");
      dCat.textContent = safeText(p.category, "UNKNOWN");
      dPrice.textContent = fmtPrice(p.price);
      dDesc.textContent = safeText(p.description, "No description available.");

      dBrand.textContent = safeText(p.brand, "-");
      dStock.textContent = safeText(p.stock, "-");
      dCreated.textContent = safeText(p.createdAt, "-");
      dId.textContent = safeText(p.id, "-");

      openImg.href = imgSrc;
      dlg.showModal();
    }

    closeBtn.addEventListener("click", () => dlg.close());
    dlg.addEventListener("click", (e) => {
      const rect = dlg.getBoundingClientRect();
      const inDialog = rect.top <= e.clientY && e.clientY <= rect.bottom && rect.left <= e.clientX && e.clientX <= rect.right;
      if (!inDialog) dlg.close();
    });

    // =========================
    // Auth logic
    // =========================
    function showAuthMsg(text, isError=false) {
      authMsg.style.display = "inline-block";
      authMsg.textContent = text;
      authMsg.style.borderColor = isError ? "rgba(255,120,120,.35)" : "rgba(255,255,255,.12)";
      authMsg.style.color = isError ? "rgba(255,200,200,.92)" : "var(--muted)";
    }

    function refreshAuthUI() {
      const token = getToken();
      const user = getUser();

      if (token && user) {
        authStatus.textContent = `ðŸ‘¤ ${user.email} (${user.role})`;
        logoutBtn.style.display = "inline-block";
        openAuth.textContent = "Account";
      } else {
        authStatus.textContent = "Not logged in";
        logoutBtn.style.display = "none";
        openAuth.textContent = "Register / Login";
      }
    }

    openAuth.addEventListener("click", () => authDialog.showModal());
    authClose.addEventListener("click", () => authDialog.close());

    logoutBtn.addEventListener("click", () => {
      clearToken();
      clearUser();
      refreshAuthUI();
      clearSavedAddress();
        fillAddressForm({fullName:"", street:"", zip:"", city:"", country:"", phone:"", email:""});


      showAuthMsg("Logged out.", false);
    });

    registerBtn.addEventListener("click", async () => {
      try {
        showAuthMsg("Registering...");
        const body = {
          email: (rEmail.value || "").trim(),
          password: rPassword.value || "",
          firstName: rFirst.value || "",
          lastName: rLast.value || ""
        };

        const res = await fetch(REGISTER_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`Register failed: HTTP ${res.status} - ${txt}`);
        }

        const data = await res.json();
        if (data?.accessToken) setToken(data.accessToken);

        setUser({ email: data.email, role: data.role });

        refreshAuthUI();
        showAuthMsg("Registered successfully. Token received.", false);
        authDialog.close();
        await refreshCart();
      } catch (e) {
        showAuthMsg(String(e), true);
      }
    });

    loginBtn.addEventListener("click", async () => {
      try {
        showAuthMsg("Logging in...");
        const body = {
          email: (lEmail.value || "").trim(),
          password: lPassword.value || ""
        };

        const res = await fetch(LOGIN_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`Login failed: HTTP ${res.status} - ${txt}`);
        }

        const data = await res.json();
        if (data?.accessToken) setToken(data.accessToken);

        setUser({ email: data.email, role: data.role });

        refreshAuthUI();
        fillAddressForm(getSavedAddress());
        showAuthMsg("Logged in successfully. Token received.", false);
        authDialog.close();
        await refreshCart();
      } catch (e) {
        showAuthMsg(String(e), true);
      }
    });

    // =========================
    // Load products
    // =========================
    async function loadProducts() {
      setState(`Loading products...<br><span class="muted">Endpoint: ${PRODUCT_LIST_ENDPOINT}</span>`);
      try {
        const res = await fetch(PRODUCT_LIST_ENDPOINT);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        allProducts = Array.isArray(data) ? data : [];

        categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();
        renderCategories();
        renderGrid();

        await refreshCart();
      } catch (err) {
        setState(
          `Could not load products.<br><br>
           Check that your product backend is running and CORS is configured.<br>
           <span class="muted">Endpoint: ${PRODUCT_LIST_ENDPOINT}</span><br>
           <span class="muted">Error: ${String(err)}</span>`,
          true
        );
      }
    }

    searchInput.addEventListener("input", renderGrid);
    categorySelect.addEventListener("change", renderGrid);
    reloadBtn.addEventListener("click", loadProducts);

    // =========================
    // Add to cart
    // =========================
    document.addEventListener("click", async (e) => {
      if (!e.target.classList.contains("add-cart-btn")) return;
      e.stopPropagation();

      const productId = e.target.dataset.id;
      const token = getToken();

      if (!token) {
        alert("Please login first to add items to cart.");
        return;
      }

      try {
        const res = await fetch(CART_ADD_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ productId: Number(productId), quantity: 1 })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        await refreshCart();
        alert("Product added to cart âœ”");
      } catch (err) {
        alert("Error adding to cart: " + err);
      }
    });

    // =========================
    // Cart
    // =========================
    function showCartMsg(text, isError=false){
      cartMsg.style.display = "inline-block";
      cartMsg.textContent = text;
      cartMsg.style.borderColor = isError ? "rgba(255,120,120,.35)" : "rgba(255,255,255,.12)";
      cartMsg.style.color = isError ? "rgba(255,200,200,.92)" : "var(--muted)";
    }

    async function fetchCartItems(){
      const token = getToken();
      if(!token) return [];

      const res = await fetch(CART_LIST_ENDPOINT, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if(!res.ok) throw new Error(`Cart list failed: HTTP ${res.status}`);
      return await res.json();
    }

    function calcTotal(items){
      return items.reduce((sum, it) => sum + (Number(it.priceSnapshot) * Number(it.quantity)), 0);
    }

    function updateCartBadge(items){
      const totalQty = items.reduce((sum, it) => sum + Number(it.quantity), 0);
      cartCount.textContent = String(totalQty);
    }

    function renderCart(items){
      if(!items.length){
        cartList.innerHTML = `<div class="state">Cart is empty.</div>`;
        cartTotal.textContent = `Total: ${fmtPrice(0)}`;
        return;
      }

      const html = items.map(it => `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06);">
          <div style="min-width:0;">
            <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${safeText(it.productName, "Unknown")}
            </div>
            <div class="muted" style="font-size:12px;">
              ${fmtPrice(it.priceSnapshot)} Â· ProductId: ${it.productId}
            </div>
          </div>

          <div style="display:flex; align-items:center; gap:8px;">
            <button class="btn qty-btn" data-action="DECREMENT" data-id="${it.productId}">âˆ’</button>
            <span class="pill">${it.quantity}</span>
            <button class="btn qty-btn" data-action="INCREMENT" data-id="${it.productId}">+</button>
            <button class="btn remove-btn" data-id="${it.productId}">Remove</button>
          </div>
        </div>
      `).join("");

      cartList.innerHTML = html;
      cartTotal.textContent = `Total: ${fmtPrice(calcTotal(items))}`;
    }

    async function refreshCart(){
      if(!getToken()){
        cartCount.textContent = "0";
        return;
      }
      try{
        const items = await fetchCartItems();
        updateCartBadge(items);
        renderCart(items);
      } catch(e){
        showCartMsg(String(e), true);
      }
    }

    openCart.addEventListener("click", async () => {
      if(!getToken()){
        alert("Please login first to view cart.");
        return;
      }
      await refreshCart();
      cartDialog.showModal();
    });

    cartClose.addEventListener("click", () => cartDialog.close());

    clearCartBtn.addEventListener("click", async () => {
      try{
        const token = getToken();
        const res = await fetch(CART_CLEAR_ENDPOINT, {
          method:"DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });
        if(!res.ok) throw new Error(`Clear failed: HTTP ${res.status}`);
        await refreshCart();
      } catch(e){
        showCartMsg(String(e), true);
      }
    });

    cartList.addEventListener("click", async (e) => {
      const token = getToken();
      if(!token) return;

      const qtyBtn = e.target.closest(".qty-btn");
      const removeBtn = e.target.closest(".remove-btn");

      try{
        if(qtyBtn){
          const productId = Number(qtyBtn.dataset.id);
          const action = qtyBtn.dataset.action; // INCREMENT/DECREMENT

          const res = await fetch(CART_UPDATE_ENDPOINT(productId), {
            method:"PUT",
            headers: {
              "Content-Type":"application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ updateAction: action })
          });

          if(!res.ok) throw new Error(`Update failed: HTTP ${res.status}`);
          await refreshCart();
          return;
        }

        if(removeBtn){
          const productId = Number(removeBtn.dataset.id);
          const res = await fetch(CART_DELETE_ENDPOINT(productId), {
            method:"DELETE",
            headers: { "Authorization": `Bearer ${token}` }
          });
          if(!res.ok) throw new Error(`Remove failed: HTTP ${res.status}`);
          await refreshCart();
        }
      } catch(err){
        showCartMsg(String(err), true);
      }
    });

    // =========================
    // Orders
    // =========================
    function showOrdersMsg(text, isError=false){
      ordersMsg.style.display = "inline-block";
      ordersMsg.textContent = text;
      ordersMsg.style.borderColor = isError ? "rgba(255,120,120,.35)" : "rgba(255,255,255,.12)";
      ordersMsg.style.color = isError ? "rgba(255,200,200,.92)" : "var(--muted)";
    }

    async function fetchOrders(){
      const token = getToken();
      if(!token) return [];
      const res = await fetch(ORDER_LIST_ENDPOINT, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if(!res.ok) throw new Error(`Orders failed: HTTP ${res.status}`);
      return await res.json();
    }

    async function fetchOrderItems(orderId){
      const token = getToken();
      const res = await fetch(ORDER_DETAIL_ENDPOINT(orderId), {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if(!res.ok) throw new Error(`Order detail failed: HTTP ${res.status}`);
      return await res.json();
    }

    function renderOrders(orders){
      ordersCount.textContent = String(orders.length);

      if(!orders.length){
        ordersList.innerHTML = `<div class="state">No orders yet.</div>`;
        return;
      }

      ordersList.innerHTML = orders.map(o => {
        const canPay = (o.status === "CREATED");
        return `
          <div style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,.06);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div style="font-weight:800;">
                Order #${o.orderId}
                <span class="pill" style="margin-left:10px;">${o.status}</span>
              </div>
              <div class="pill">${fmtPrice(o.totalAmount)}</div>
            </div>

            <div class="muted" style="margin-top:6px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <div>Items: ${(o.items || []).length}</div>

              <div style="display:flex; gap:8px;">
                ${canPay ? `<button class="btn accent" data-action="PAY" data-id="${o.orderId}" data-total="${o.totalAmount}">Pay</button>` : ``}
                <button class="btn" data-action="DETAIL" data-id="${o.orderId}">Details</button>
              </div>
            </div>

            <div id="orderItems-${o.orderId}" style="display:none; margin-top:8px;"></div>
          </div>
        `;
      }).join("");
    }

    async function refreshOrders(){
      try{
        const orders = await fetchOrders();
        renderOrders(orders);
      } catch(e){
        showOrdersMsg(String(e), true);
      }
    }

    openOrders.addEventListener("click", async () => {
      if(!getToken()){
        alert("Please login first to view orders.");
        return;
      }
      await refreshOrders();
      ordersDialog.showModal();
    });

    ordersClose.addEventListener("click", () => ordersDialog.close());

    // âœ… Orders actions: PAY + DETAIL
    ordersList.addEventListener("click", async (e) => {
      const payBtn = e.target.closest("button[data-action='PAY']");
      if(payBtn){
        const orderId = Number(payBtn.dataset.id);
        const total = Number(payBtn.dataset.total);
        openPayment(orderId, total);
        return;
      }

      const detailBtn = e.target.closest("button[data-action='DETAIL']");
      if(!detailBtn) return;

      const orderId = Number(detailBtn.dataset.id);
      const box = document.getElementById(`orderItems-${orderId}`);

      if(box.style.display === "block"){
        box.style.display = "none";
        box.innerHTML = "";
        detailBtn.textContent = "Details";
        return;
      }

      try{
        detailBtn.textContent = "Loading...";
        const items = await fetchOrderItems(orderId);

        if(!items.length){
          box.innerHTML = `<div class="state">No items found for this order.</div>`;
        } else {
          box.innerHTML = items.map(it => `
            <div style="display:flex; justify-content:space-between; gap:10px; padding:6px 0;">
              <div style="min-width:0;">
                <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${safeText(it.productName, "Unknown")}
                </div>
                <div class="muted" style="font-size:12px;">
                  ${fmtPrice(it.unitPrice)} Ã— ${it.quantity} Â· productId: ${it.productId}
                </div>
              </div>
              <div class="pill">${fmtPrice(Number(it.unitPrice) * Number(it.quantity))}</div>
            </div>
          `).join("");
        }

        box.style.display = "block";
        detailBtn.textContent = "Hide";
      } catch(err){
        detailBtn.textContent = "Details";
        showOrdersMsg(String(err), true);
      }
    });

    // =========================
    // Payment dialog logic
    // =========================
    let currentPayOrderId = null;

    function showPaymentMsg(text, isError=false){
      paymentMsg.style.display = "inline-block";
      paymentMsg.textContent = text;
      paymentMsg.style.borderColor = isError ? "rgba(255,120,120,.35)" : "rgba(255,255,255,.12)";
      paymentMsg.style.color = isError ? "rgba(255,200,200,.92)" : "var(--muted)";
    }

    function resetPaymentDialog(){
      currentPayOrderId = null;
      payOrderIdEl.textContent = "-";
      payTotalEl.textContent = "-";
      payNowBtn.disabled = true;
      paymentMsg.style.display = "none";
      paySpinner.style.display = "none";
      document.querySelectorAll("input[name='payMethod']").forEach(r => r.checked = false);
    }

    function openPayment(orderId, totalAmount){
      resetPaymentDialog();
      currentPayOrderId = orderId;
      payOrderIdEl.textContent = String(orderId);
      payTotalEl.textContent = fmtPrice(totalAmount);
      paymentDialog.showModal();
    }

    paymentClose.addEventListener("click", () => paymentDialog.close());
    paymentDialog.addEventListener("close", resetPaymentDialog);

    document.addEventListener("change", (e) => {
      if (e.target && e.target.name === "payMethod") {
        payNowBtn.disabled = false;
      }
    });

    async function findOrderById(orderId){
      const orders = await fetchOrders();
      return orders.find(o => Number(o.orderId) === Number(orderId));
    }

payNowBtn.addEventListener("click", async () => {
  const token = getToken();
  if (!token) {
    alert("Please login first.");
    return;
  }

  const selected = document.querySelector("input[name='payMethod']:checked");
  if (!selected) {
    showPaymentMsg("Please select a payment method.", true);
    return;
  }

  try {
    payNowBtn.disabled = true;
    paySpinner.style.display = "inline-block";
    showPaymentMsg("ðŸ’³ Payment is processingâ€¦ Please wait.", false);

    // 1ï¸âƒ£ Payment start
    const body = {
      orderId: Number(currentPayOrderId),
      paymentMethode: selected.value
    };

    const res = await fetch(PAYMENT_START_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Payment start failed: ${txt}`);
    }

    // 2ï¸âƒ£ ÅžÄ°MDÄ° BEKLE VE ORDER STATUS'U KONTROL ET
    const updated = await waitForOrderFinalStatus(currentPayOrderId, 15000);
    paySpinner.style.display = "none";

    if (!updated) {
      showPaymentMsg(
        "â³ Payment processed, but status update is taking longer than expected. Please check your orders.",
        true
      );
      return;
    }

        paySpinner.style.display = "none";
        paymentDialog.close();


    // 3ï¸âƒ£ SONUCU GÃ–STER
    if (updated.status === "PAID") {
      openResultPopup(
        "âœ… Payment successful",
        `Payment received. Your order is being prepared. OrderId: ${updated.orderId}`
      );
    } else {
      openResultPopup(
        "âŒ Payment failed",
        `Payment failed. Please try again. OrderId: ${updated.orderId}`
      );
    }


    // 4ï¸âƒ£ Orders ekranÄ±nÄ± gÃ¼ncelle
    await refreshOrders();

  } catch (e) {
    paySpinner.style.display = "none";
    showPaymentMsg(String(e), true);
  } finally {
    payNowBtn.disabled = false;
  }
});


    // =========================
    // Checkout (Cart -> Order) + auto open payment
    // =========================
    checkoutBtn.addEventListener("click", async () => {
  const token = getToken();
  if(!token){
    alert("Please login first.");
    return;
  }

  // cart boÅŸsa adres istemeyelim
  try{
    const items = await fetchCartItems();
    if(!items.length){
      showCartMsg("Cart is empty.", true);
      return;
    }
  } catch(e){
    showCartMsg(String(e), true);
    return;
  }

  // formu doldur (varsa localStorageâ€™dan)
  fillAddressForm(getSavedAddress());
  addressDialog.showModal();
});
addressContinue.addEventListener("click", async () => {
  const token = getToken();
  if(!token){
    alert("Please login first.");
    return;
  }

  const addr = readAddressFromForm();
  const err = validateAddress(addr);
  if(err){
    showAddressMsg(err, true);
    return;
  }

  setSavedAddress(addr);
  showAddressMsg("Creating order...", false);

  try{
    // Order checkout request body
    const checkoutBody = {
      deliveryAddress: addr
    };

    const res = await fetch(ORDER_CHECKOUT_ENDPOINT, {
      method:"POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(checkoutBody)
    });

    if(!res.ok){
      const txt = await res.text();
      throw new Error(`Checkout failed: HTTP ${res.status} - ${txt}`);
    }

    const data = await res.json(); // { orderId: ... }

    addressDialog.close();
    cartDialog.close();

    showCartMsg(`âœ… Order created. OrderId: ${data.orderId}`, false);

    await refreshCart();
    await refreshOrders();

    const created = await findOrderById(data.orderId);
    if(created){
      openPayment(created.orderId, created.totalAmount);
    } else {
      openPayment(data.orderId, 0);
    }

  } catch(e){
    showAddressMsg(String(e), true);
  }
});


    async function waitForOrderFinalStatus(orderId, timeoutMs = 15000) {
  const start = Date.now();

  while (Date.now() - start < timeoutMs) {
    const updated = await findOrderById(orderId);

    if (updated && (updated.status === "PAID" || updated.status === "FAILED")) {
      return updated;
    }

    await new Promise(r => setTimeout(r, 1000)); // 1 saniye bekle
  }

  return null; // timeout
}

    function openResultPopup(title, text){
      resultTitle.textContent = title;
      resultText.textContent = text;
      resultDialog.showModal();
    }

      function forceCloseDialog(dlgEl){
      if(!dlgEl) return;
      try {
        if (dlgEl.open) dlgEl.close();
      } catch {}
    }
    function goHomeAfterResult(){
      // âœ… her ÅŸeyi kapat
      forceCloseDialog(paymentDialog);
      forceCloseDialog(ordersDialog);
      forceCloseDialog(cartDialog);
      forceCloseDialog(resultDialog);

      // âœ… anasayfa hissi
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    resultClose.addEventListener("click", () => {
      resultDialog.close();
      goHomeAfterResult();
    });

    resultOk.addEventListener("click", () => {
      resultDialog.close();
      goHomeAfterResult();
    });

    resultDialog.addEventListener("close", goHomeAfterResult);

    // =========================
    // Init
    // =========================
    refreshAuthUI();
    loadProducts();
</script>

</body>
</html>
